---
layout: post
title: "교착상태(데드락, Deadlock)와 해결방법"
categories: [OS]
comments: true
tags:
  - OS
  - Deadlock
---

## 교착상태(Deadlock)
**교착상태**: 프로세스가 필요한 자원을 얻지 못해 다음 처리를 못하는 상태
- 물리적 자원, 논리적 자원 모두 해당
    - 물리적인 자원: 프린터, 테이프 드라이브, 메모리 공간, CPU 주기 등
    - 논리적인 자원: 파일, 세마포어 등 
- 실행을 끝낼 수 없음
- 다른 작업 시작 불가능

**발생 상황**

![deadlock](deadlock.gif)

### 필요 조건
교착상태가 발생하려면 다음의 네 가지 조건이 성립되어야 한다. 
- 상호 배제(mutual exclusion): 자원은 한 번에 하나의 프로세스만 사용할 수 있다. 
    - 해당 자원을 요청하는 다른 프로세스는 자원이 방출될 때까지 지연된다. 
- 점유하며 대기(hold-and-wait): 프로세스는 최소한 하나의 자원을 점유한 채 대기해야 한다. 
- 비선점(no preemption): 점유된 자원은 선점할 수 없다.
    - 자원이 강제적으로 방출될 수 없고, 프로세스 종류 후 자발적으로만 방출된다.
- 순환 대기(circular wait): 프로세스의 집합 {P0, P1, ,…Pn}에서 P0는 P1이 점유한 자원을 대기하고 P1은 P2가 점유한 자원을 대기하고 P2…Pn-1은 Pn이 점유한 자원을 대기하며 Pn은 P0가 점유한 자원을 요구해야 한다.

### 자원 할당 그래프 
프로세스와 자원의 관계를 아래와 같이 그래프로 나타낼 수 있다. 

![resource allocation graph](resource-allocation-graph.jpg)

그래프가 사이클을 포함하면 교착상태가 존재할 수 있다. 

## 교착 상태 처리 방법
- 예방/회피
    - 프로세스가 일생동안 요구하고 사용할 자원에 대한 부가적인 정보를 미리 제공해야 함
- 회복
    - 시스템의 상태 조사 알고리즘 제공
    - 복구 알고리즘 제공
- 무시
    - 교착상태가 매우 드물게 일어남
    - 예방, 회피, 탐지 방법들보다 무시하는 것이 더 적은 비용이 듦

### 교착상태 예방(Deadlock Prevention)
교착상태의 네 가지 필요조건 중 최소한 하나가 성립하지 않도록 함으로써 교착상태의 발생을 예방할 수 있다. 

#### 상호 배제
- 공유 불가능한 자원에 대해서는 상호 배제가 반드시 성립해야 한다. 
- 공유 가능한 자원들은 교착상태에 관련될 수 없다. 
    - 배타적인 접근을 요구하지 않음 
- 상호 배제 조건을 인정하지 않음으로써 교착상태를 예방하는 것은 불가능
    - 어떤 자원들은 근본적으로 공유가 불가능하기 때문

#### 점유하며 대기 
- 프로세스가 실행되기 전에 반드시 자신의 모든 자원을 요청해 할당받게 한다. 
- 프로세스가 자원을 전혀 갖고 있지 않을 때만 자원을 요청할 수 있도록 허용한다. 

#### 비선점 
- 어떤 자원을 점유하고 있는 프로세스가 즉시 할당할 수 없는 다른 자원을 요청하면, 현재 점유하고 있는 모든 자원들이 선점된다. 
    - 프로세스는 자신이 필요로 하는 모든 자원을 획득할 수 있을 때에만 다시 시작된다. 
- 한 프로세스가 자원들을 요청하면, 이들이 사용 가능한지를 검사한다. 
    - 사용 가능하다면, 자원을 할당한다. 
    - 사용 불가능하면, 자원들이 추가 자원을 기다리고 있는 다른 프로세스에게 할당되어 있는지를 검사한다. 
        - 만약 그렇다면 자원을 선점해 요청 프로세스에게 할당한다.
        - 아니라면 요청 프로세스는 대기한다. 
        - 요청 프로세스가 대기하는 동안 다른 프로세스가 자원을 요청하면 선점될 수 있다. 

#### 순환 대기 
- 모든 자원에 순서를 부여해 각 프로세스가 열거된 순서대로(오름차순으로) 자원을 요청하도록 요구한다. 
    - 프로세스는 초기에 자원을 몇 개든지 요청할 수 있다. 
    - 그 후에는 더 높은 순서의 인스턴스만 요청할 수 있다. 
- 프로세스가 인스턴스를 요청할 때마다 더 높거나 같은 순서의 자원을 모두 방출하도록 요구한다. 
    - 동일한 유형의 자원이 여러 개 필요한 경우, 한 번에 모든 자원을 할당받아야 한다. 

### 교착상태 회피(Deadlock Avoidance)
각 프로세스의 자원 요청과 방출에 대한 순서와 최대 개수를 알고 있다면, 교착상태 회피 알고리즘을 정의할 수 있다. 교착상태 회피 알고리즘은 동적으로 자원 할당 상태를 검사한다. 

- 안전 상태(Safe State) 유지
    - 시스템 상태가 안전 -> 시스템이 어떤 순서로든 프로세스들이 요청하는 모든 자원을 교착상태 없이 차례로 모두 할당해 줄 수 있다는 뜻
- 자원 할당 그래프 알고리즘
    - 프로세스 실행 전 자원이 미리 예약되어야 그래프에 표시 가능 
    - 사이클 탐지 알고리즘을 이용해 안전성 검사 
- 은행원 알고리즘 
    - 프로세스가 시작할 때 프로세스가 가지고 있어야 할 자원의 최대 개수를 모두 미리 신고해야 함

### 교착상태 탐지(Deadlock Detection)
각 자원 타입이 한 개씩 있는 경우
- 대기 그래프(wait-for graph) 사용
    - 자원 할당 그래프의 변형
    - 프로세스간 가지고 있는 자원들에 대해 방출을 기다리는 상태를 표시 
    - 사이클을 포함하면 교착상태가 생길 수 있음 

        ![graphs](wait-for-graph.jpg)

각 타입의 자원을 여러 개 가진 경우 
- 가능한 모든 할당 순서를 조사해 보는 알고리즘 사용 

### 교착상태로부터 회복(Recovery from Deadlock)
#### 프로세스 종료
- 교착상태 프로세스를 모두 중지
    - 비용이 큼
        - 프로세스들의 부분 계산 결과들을 반드시 폐기해야 함
- 교착상태가 제거될 때까지 한 프로세스 씩 중지
    - 각 프로세스가 중지될 때마다 교착상태 탐지 알고리즘 호출

중지할 프로세스를 선택하는 데는 다음과 같은 요인들이 있다. 
- 프로세스의 우선순위
- 지금까지 프로세스가 실행된 시간과 종료하는 데 더 필요한 시간
- 프로세스가 사용한 자원 타입과 수
- 프로세스가 종료하기 위해 더 필요한 자원의 수
- 얼마나 많은 수의 프로세스가 종료되어야 하는지
- 프로세스가 대화형(interactive)인지 일괄처리(batch)인지 여부

#### 자원 선점 
자원 선점을 이용해 교착상태를 제거하려면, 교착상태가 깨어질 때까지 프로세스로부터 자원을 계속 선점해 다른 프로세스에게 주어야 한다. 

자원 선점은 다음의 사항들을 고려해야 한다. 
- 희생자 선택
- 롤백
    - 자원을 선점당한 프로세스를 안전한 상태로 롤백시키고 다시 시작해야 한다. 

- 기아 상태
    - 희생자 선택 기준에 의해 항상 동일한 프로세스가 희생자로 선택될 수 있다. 
    - 한정된 시간 동안만 희생자로 선택된다는 것을 보장해야 한다. 
        - 비용 요소에 롤백의 횟수를 포함시킬 수 있다. 
        
#### Reference
<https://afteracademy.com/blog/what-is-deadlock-and-what-are-its-four-necessary-conditions><br>
<https://jwprogramming.tistory.com/12#><br>